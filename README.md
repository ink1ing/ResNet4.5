# 玉米南方锈病遥感识别系统

本项目基于深度学习技术，构建玉米南方锈病的遥感识别模型，实现对感染部位和感染等级的自动识别。通过多任务学习方法，同时实现两个目标：

1. **感染部位分类**：下部/中部/上部 (3分类)
2. **感染等级判断**：无/轻度/中度/重度/极重度 (对应病害等级：0/3/5/7/9)

## 项目概述

项目使用无人机获取的多光谱图像(.tif)和人工标注文件(.json)，通过深度学习模型实现玉米南方锈病的智能识别。项目分为两个阶段：

1. **阶段一（已完成）**：使用14叶片数量的小样本验证模型框架和训练流程
2. **阶段二（当前）**：扩展到9个文件夹数据集（9l/m/t、14l/m/t、19l/m/t），每类101张，共909张样本对

## 项目更新说明

### 最新更新
我们持续优化了训练流程和数据处理策略，最新改进包括：

1. **数据集分割优化**：
   - 将原有训练/验证分割比例调整为8:1:1（训练集:验证集:测试集）
   - 添加了专门的测试集评估，在训练结束后自动输出测试集性能指标

2. **数据增强增强**：
   - 增强了旋转增强策略，同时支持标准角度（90°/180°/270°）和随机角度（-30°~30°）旋转
   - 提高了数据增强多样性，增强模型泛化能力

3. **多光谱图像处理**：
   - 修复了图像维度不一致问题（从[128, 600, 128]到[3, 128, 128]）
   - 实现了从500通道中选择3个代表性通道的策略
   - 使用scikit-image库替代transforms_functional.resize函数处理多通道图像

4. **损失函数优化**：
   - 修复了FocalLoss实现中的维度不匹配问题
   - 增强了多任务学习的损失函数，更好地平衡位置分类和等级回归任务

5. **训练稳定性**：
   - 降低了学习率（0.0001）和批次大小（8/4）以提高训练稳定性
   - 优化了数据加载和预处理流程，提高训练效率

## 数据结构

### 图像数据
- 多光谱遥感图像（.tif格式）
- 图像维度：[500, H, W]，其中500是光谱通道数
- 存储路径：`./guanceng-bit/`目录下，按叶片和位置分为9个子目录：
  - 9l, 9m, 9t（9叶期下/中/上部）
  - 14l, 14m, 14t（14叶期下/中/上部）
  - 19l, 19m, 19t（19叶期下/中/上部）

### 标注数据
- JSON格式标注文件，与图像文件一一对应
- 存储路径：`./biaozhu_json/`目录下，按叶片和位置分为9个子目录（与图像目录对应）
- 标注内容：
  - 感染部位：通过文件路径中的l/m/t标识（下/中/上部）
  - 感染等级：通过标签名称中的数字标识（0/3/5/7/9）

## 数据增强与分割

### 数据分割
- 训练集/验证集/测试集比例：8:1:1
- 采用随机分割策略，保证各类别样本在三个集合中的分布均衡
- 使用固定随机种子（42）确保实验可重复性

### 数据增强
应用多种增强策略提高模型泛化能力：
1. **随机翻转**：水平和垂直翻转（各50%概率）
2. **随机旋转**：两种旋转模式
   - 标准旋转：90°/180°/270°（50%概率）
   - 随机角度旋转：-30°~30°范围内的随机角度（50%概率）
3. **亮度/对比度调整**：±20%范围内随机变化
4. **通道混合**：随机排列输入通道顺序，增加特征多样性

## 模型架构

项目实现了三种模型架构：
1. **简单CNN**（`DiseaseClassifier`）：基础卷积神经网络，双头输出
2. **ResNet**（`DiseaseResNet`）：基于残差连接的深度网络
3. **ResNet+**（`DiseaseResNetPlus`）：增强版ResNet，加入通道和空间注意力机制

所有模型都采用多任务学习方法，同时预测：
- 感染部位（3分类问题）：下部/中部/上部
- 感染等级（回归问题）：0-9范围内的连续值

## 项目结构

- **model.py**: 模型定义文件，包含三种网络架构
- **dataset.py**: 数据集加载和预处理，处理TIF图像和JSON标注
- **train.py**: 训练主脚本，包含训练循环和评估函数
- **run_optimized.py**: 优化版训练启动脚本
- **utils.py**: 工具函数，包含损失函数、指标计算等
- **check_tif_images.py**: TIF图像检查工具，用于分析图像结构
- **check_training_results.py**: 训练结果分析工具
- **test.py**: 模型测试脚本
- **run_testing.py**: 测试启动脚本

## 快速开始

### 环境准备
```bash
pip install torch torchvision rasterio scikit-image matplotlib tqdm seaborn numpy pillow
```

### 检查图像数据
```bash
python check_tif_images.py --data_root ./guanceng-bit --sample_count 5 --visualize
```

### 启动训练
```bash
python run_optimized.py --data_root ./guanceng-bit --json_root ./biaozhu_json --num_workers 2 --batch_size 8 --output_dir ./output --model_type resnet_plus --epochs 30 --lr 0.0001
```

### 继续训练
```bash
python run_optimized.py --checkpoint ./output/weights_epoch_6.pth --data_root ./guanceng-bit --json_root ./biaozhu_json --num_workers 2 --batch_size 8 --output_dir ./output_continued --model_type resnet_plus
```

### 检查训练结果
```bash
python check_training_results.py --output_dir ./output
```

### 测试模型
```bash
python run_testing.py --data_root ./guanceng-bit --json_root ./biaozhu_json --model_path ./output/best_model.pth
```

## 训练参数配置

当前最优参数配置（针对多光谱图像优化）：
- 模型类型：ResNet+（带注意力机制）
- 图像大小：128x128
- 输入通道数：3（从500通道中选择）
- 损失函数：Focal Loss（γ=2.0）
- 学习率：0.0001（降低以提高稳定性）
- 批次大小：8（GPU）/ 4（CPU）
- 优化器：Adam
- 学习率调度：ReduceLROnPlateau
- 数据分割：8:1:1（训练集:验证集:测试集）

## 性能指标

模型性能通过以下指标评估：
- 位置分类：准确率、F1分数、精确率、召回率、混淆矩阵
- 等级预测：平均绝对误差(MAE)、±2误差容忍率
- 训练和验证指标自动记录，训练结束后自动输出测试集性能

## 常见问题

**Q: 如何处理不同波段数的.tif文件?**  
A: 数据集类会自动处理不同波段数的.tif文件，如果通道数小于3，会复制现有通道；如果大于3，会选择代表性通道。

**Q: 无法读取.tif文件怎么办?**  
A: 确保安装了rasterio库并有适当的GDAL支持。如果遇到读取问题，检查.tif文件的格式和完整性。

**Q: 如何调整两个任务的损失权重?**  
A: 在训练脚本中可以通过task_weights参数调整，默认为[0.7, 0.3]，表示位置分类任务占70%，等级回归任务占30%。

**Q: 如何使用自己的数据集?**  
A: 准备好.tif图像和对应的.json标注文件，按照项目的目录结构组织，然后按需调整`CornRustDataset`类中的标签解析逻辑。

**Q: 数据增强如何影响训练效果?**  
A: 我们的增强策略（特别是旋转增强）显著提高了模型泛化能力，对不同角度拍摄的图像适应性更好。您可以通过`aug_prob`参数调整增强应用概率。

## 注意事项和建议

1. **数据预处理**：
   - 多光谱图像处理需要特别注意通道选择和维度处理
   - 确保图像和标注文件正确匹配

2. **训练资源**：
   - 处理多光谱图像需要较大内存，建议使用GPU训练
   - 如果出现内存不足，可进一步减小批次大小

3. **模型选择**：
   - 简单任务可使用基础CNN模型
   - 复杂场景建议使用ResNet+模型，注意力机制有助于捕捉关键特征

4. **后续优化方向**：
   - 探索更多通道选择策略，提取更有代表性的光谱信息
   - 尝试更复杂的多任务学习权重策略
   - 考虑引入迁移学习，利用预训练模型
   - 扩展数据增强方法，进一步提高模型泛化能力